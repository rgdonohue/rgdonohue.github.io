<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>New Maps Chapter 3 Example 11 &ndash; Choropleth Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.1/normalize.min.css" />
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

<style>
    body { margin:0; padding:0; font-family: "Open Sans"; }
    h1 { position: absolute; z-index: 200; padding: 4px 8px; color: #222; background: whitesmoke; left: 80px; border-radius: 3px;}
    h3 { margin: 0;}
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #legend { position: absolute; bottom: 80px; right: 60px; padding: 8px 12px; background: whitesmoke; border-radius: 3px; }
    .legendSquare { float: left; width: 20px; height: 20px; display: inline-block; margin-right: 5px ; }
    #ui-controls { position: absolute; top: 15px; right: 10px; padding: 6px 8px; background: whitesmoke; border-radius: 5px; }
</style>
</head>
<body>
<div id='map'></div>

<div id='ui-controls'>
	<select name="geography">
	  <option value="states" selected>US States</option> 
	  <option value="counties">US Counties</option>
	</select>
	<select name="source">
	  <option value="sumMw" selected>All Fuel Sources</option> 
	  <option value="BIT_avgMW">Bituminous Coal</option>
	    <option value="SUB_avgMW">Subuminous Coal</option>
	  <option value="NG_avgMW">Natural Gas</option>
	  <option value="NUC_avgMW">Nuclear</option>
	  <option value="WAT_avgMW">Hydro</option>
	  <option value="WND_avgMW">Wind</option>
	</select>

	<select name="class-method">
	  <option value="quantile" selected>Quantile</option>
	  <option value="equalInterval">Equal Interval</option> 
	  <option value="jenks">Jenks</option>
	</select>

	<select name="class-num">
	  <option value="3">3 Classes</option> 
	  <option value="4">4 Classes</option> 
	  <option value="5" selected>5 CLasses</option>
	  <option value="6">6 Classes</option> 
	  <option value="7">7 Classes</option> 
	  <option value="8">8 CLasses</option>
	  <option value="9">9 CLasses</option>
	</select>
</div>
<div id='legend'></div>


<script src="ss.js"></script>
<script>


(function() {

	// create a map in the "map" div, set the view to display the continental US
	var map = L.map('map').setView([40,-95], 5);


	var Esri_WorldGrayCanvas = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ'
	}).addTo(map);

	// object to store our AJAX loaded data
	var data = {};

	// initiate AJAX requests to load external data resources
	$.when(
		$.getJSON("data/countiesWithPlants.json", function(counties) {

			data.counties =  counties;

		}),
		$.getJSON("data/statesWithPlants.json", function(states) {

			data.states =  states;

		})

	).then(function() { // once all the external resources are loaded

		// send those data to another function
		drawMap(data.states, data.counties)

	});

	// available attributes are sumMw, NG_avgMW, BIT_avgMW, SUB_avgMW, NUC_avgMW, WAT_avgMW, WND_avgMW, RFO_avgMW, DFO_avgMW, LIG_avgMW
	var currentAttribute = 'sumMw';

	// available methods are equalInterval, jenks, and quantile
	var	classificationMethod = 'quantile'; 

	var currentGeography = 'states';
	
	var currentClassNum = 5;

	function drawMap(statesGeoJson, countiesGeoJson) {

		var counties = L.geoJson(countiesGeoJson, {

			style: {
				color: "#b1b8b8",
				weight: 1,
				fillColor: null,
				fillOpacity: 1
			}

		}).addTo(map);

		// state borders to make it look nice (and to locate counties within states)
		var states = L.geoJson(statesGeoJson, {
			style: {
				color: "#e4e3db",
				weight: 3,
				fillColor: null,
				fillOpacity: 1
			}
		}).addTo(map)

		// update thematic symbology based on current
		if(currentGeography == 'states') {
			updateMap(states)
		}
		if(currentGeography == 'counties') {
			updateMap(counties);
		}
		
		// when user selects another option
		$('select').change(function() {

			var target = $(this);

			if(target.attr('name') == 'geography') {
				currentGeography = target.val();
			}
			if(target.attr('name') == 'source') {
				currentAttribute = target.val();
			}
			if(target.attr('name') == 'class-method') {
				classificationMethod = target.val();
			}
			if(target.attr('name') == 'class-num') {
				currentClassNum = target.val();
			}

			if(currentGeography == 'counties') {
			
				states.setStyle({fillOpacity: 0});
				
				updateMap(counties);
			}

			if(currentGeography == 'states') {

				states.setStyle({fillOpacity: 1});

				updateMap(states);
			}


		});

	}

	function updateMap(geographies) {
		
		var currentData = [];

		geographies.eachLayer(function(layer) {
			var val = layer.feature.properties[currentAttribute]/(layer.feature.properties['ALAND']);
			if(val != null && val != 0) {
				currentData.push(val);
	
			}
		});

		// get classbreaks for the dataset of currently selected Attribute
		var classBreaks = getClassBreaks(currentData,classificationMethod,currentClassNum);
		

		// some color schemes for # of classes
		var orRd = {
			3: ["#fee8c8","#fdbb84","#e34a33"],
			4: ["#fef0d9","#fdcc8a","#fc8d59","#d7301f"],
			5: ["#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"],
			6: ["#fef0d9","#fdd49e","#fdbb84","#fc8d59","#e34a33","#b30000"],
			7: ["#fef0d9","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#990000"],
			8: ["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#990000"],
			9: ["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"]
		}

		geographies.eachLayer(function(layer) { // for each layer

			var props = layer.feature.properties;
		
			var total = props[currentAttribute],
					area = props.ALAND, // standardize the current attribute
					value = total/area;
				
			layer.setStyle({

				fillColor: classify(value,classBreaks,orRd[currentClassNum]) // and colorize that layer based on the current classification

			});

		});

		var legend = $("#legend").html("<h3>MW power/<br> 10,000km&#178;</h3><br>"); // update legend

		for(var j=0;j<classBreaks.length-1;j++) {

			var square = "<div class='legendSquare' style='background:"+orRd[currentClassNum][j]+"'></div>"

			legend.append(square + 
				Math.round(classBreaks[j]*1E11)/1000+ ' &ndash; ' +
				Math.round(classBreaks[j+1]*1E11)/1000+"<br>");
		}

	}

	function getClassBreaks(dataSet,method,num) {

		// determine break values based on selected classfication method
		if(method == 'jenks') {

			var breaks = ss.jenks(dataSet,num);

		}
		if(method == 'quantile') {

			var p = [0];
			for (var i = 0; i < num-1; i++) {
				p[i+1] = (i+1)/num;
			}
			p.push(1);
			var breaks = ss.quantile(dataSet,p);

		}
		if(method == "equalInterval") {

			var min = ss.min(dataSet),
				max = ss.max(dataSet),
				classDif = (max - min)/num,
				breaks = [min];

			for (var i = 0; i < num; i++) {
				
				breaks[i+1] = min + classDif*(i+1);
			}

		}

		return breaks;

	}

	function classify(value,breaks,colors) {

		for(var i=0;i<breaks.length;i++) {

			if(value <= breaks[i+1]) {

				return colors[i];

			}

		}

	}



})();

</script>
</body>
</html>